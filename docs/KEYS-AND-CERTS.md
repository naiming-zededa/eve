# Keys and certificates generated and used by EVE

## Introduction

In order to satisfy all of the security requirements discussed in [SECURITY](SECURITY.md), and work with the constraints of trusted platform modules (TPMs) when it comes to different key usage, EVE requires several different keys and associated certificates.

In addition, to handle the multi-level security for communication with the controller (TLS as a base, then object signing to prevent content-inspecting enterprise proxies from modifying configuration etc, then object encryption to prevent such proxies from seeing confidential configuration information) there are several certificates needed from the controller.

## Keys and certificates generated on edge node

If EVE is running on hardware with a trusted platform module (TPM), then these key pairs are generated by the TPM, and the certificates are stored both in the filesystem and in the case of the key device certificate, also stored in the TPM's NVRAM. If there is no TPM then the private keys are also stored in the file system.

| Key/cert | Purpose | Type | Location | Reference |
|----------|---------|------|----------|-----------|
| Device key   | Prove the identity of the device |  ECC (P-256) | TPM or /config/device.key.pem | [Identity of EVE](SECURITY.md#identity-of-eves-instance) |
| Device cert  | Secure identity of the device | ECC (P-256) | /config/device.cert.pem | [Identity of EVE](SECURITY.md#identity-of-eves-instance) |
| ECDH key | For API object encryption | ECC (P-256) | TPM or /persist/certs/ecdh.key.pem | [Config object encryption](OBJECT-LEVEL-ENCRYPTION.md) |
| ECDH cert | For API object encryption | ECC (P-256) | /persist/certs/ecdh.cert.pem | [Config object encryption](OBJECT-LEVEL-ENCRYPTION.md) |
| Attestation key | Sign the attestation | ECC (P-256) | TPM or /persist/certs/attest.cert.pem | [Measured Boot and Remote Attestation](https://wiki.lfedge.org/display/EVE/Measured+Boot+and+Remote+Attestation) |
| Attestation cert | Sign the attestation | ECC (P-256) | /persist/certs/attest.cert.pem | [Measured Boot and Remote Attestation](https://wiki.lfedge.org/display/EVE/Measured+Boot+and+Remote+Attestation) |
| Onboarding key | Used initially for onboarding | ECC (P-256) | /config/onboard.key.pem | [Registration](Registration.md) |
| Onboarding cert | Used initially for onboarding | ECC (P-256) | /config/onboard.cert.pem |  [Registration](Registration.md) |
| Endorsement cert | Needed for some use of vTPM | Depends on TPM | Generated by TPM | [Identity of EVE](SECURITY.md#identity-of-eves-instance) |

### Storage keys

EVE implements a vault for application content and volumes in /persist/vault/. This is encrypted using standard filesystem encryption (fscrypt for the ext4 file system and native ZFS encryption for the ZFS file system).

But master key for this is managed using EVE using the TPM to seal the keys under the TPM PCRs, and with an encrypted copy of the master key being sent to the controller as a backup, and which the controller will share with the device after successful attestation as specified in [Measured Boot and Remote Attestation](https://wiki.lfedge.org/display/EVE/Measured+Boot+and+Remote+Attestation).

This master storage key is not kept on disk/ssd; only in memory on the running system plus the TPM-sealed one and in the encrypted backup in the controller.

## Controller certificates used by EVE

| Certificate | Purpose | Type | Location | Reference |
|-------------|---------|------|----------|-----------|
| Root of trust | Validate legitimate controller | Any | /config/root-certificate.pem | [Trusting controller](SECURITY.md#eve-trusting-its-controller) |
| Signing cert | Signing of API messages | Any | /persist/certs/server-signing-cert.pem | Populated using the EVE API. See [SIGNING](../api/OBJECT-SIGNING.md) |
| ECDH cert | Api object encryption | ECC (P-256) | Only in memory | [Config object encryption](OBJECT-LEVEL-ENCRYPTION.md) |

## Other certificates

| Certificate | Purpose | Type | Location |
|-------------|---------|------|----------|
| TLS root of trust | Standard TLS | Any | /config/v2tlsbaseroot-certificates.pem |
